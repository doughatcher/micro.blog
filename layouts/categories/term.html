{{ define "main" }}
<div class="category-page">
    <div class="page-description">
        <p>Posts in <strong>{{ .Title }}</strong> category</p>
    </div>

    <div class="publications-list">
        {{ range .Pages }}
        {{ $externalLink := .Permalink }}
        {{ $contentLink := "" }}
        {{ $linkDomain := "" }}
        
        {{/* Extract link from content using regex */}}
        {{ $content := .Content }}
        {{ if findRE `href="([^"]+)"` $content 1 }}
            {{ $matches := findRE `href="([^"]+)"` $content 1 }}
            {{ $match := index $matches 0 }}
            {{ $contentLink = replaceRE `href="([^"]+)"` "$1" $match }}
            {{ $externalLink = $contentLink }}
            {{/* Extract domain from URL */}}
            {{ if findRE `https?://([^/]+)` $contentLink 1 }}
                {{ $domainMatches := findRE `https?://([^/]+)` $contentLink 1 }}
                {{ $domainMatch := index $domainMatches 0 }}
                {{ $linkDomain = replaceRE `https?://([^/]+)` "$1" $domainMatch }}
            {{ end }}
        {{ else if .Params.canonical_url }}
            {{ $externalLink = .Params.canonical_url }}
            {{ $contentLink = .Params.canonical_url }}
        {{ end }}
        
        <article class="publication-item">
            {{ if or .Params.thumbnail (index .Params.photos 0) (index .Params.images 0) }}
            <div class="publication-thumbnail">
                {{ $thumbnail := .Params.thumbnail }}
                {{ if not $thumbnail }}
                    {{ $thumbnail = index .Params.photos 0 }}
                {{ end }}
                {{ if not $thumbnail }}
                    {{ $thumbnail = index .Params.images 0 }}
                {{ end }}
                <a href="{{ $externalLink }}" target="_blank" rel="noopener noreferrer">
                    <img src="{{ $thumbnail }}" alt="{{ .Title }}" loading="lazy">
                </a>
            </div>
            {{ end }}
            
            <div class="publication-content-wrapper">
                <h2 class="publication-title">
                    <a href="{{ $externalLink }}" target="_blank" rel="noopener noreferrer">
                        {{ .Title }}
                        {{ if $contentLink }}
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-left: 0.25rem; vertical-align: middle;">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6m4-3h6v6m-11 5L21 3"/>
                        </svg>
                        {{ end }}
                    </a>
                </h2>
                
                {{ if .Params.publication }}
                <p class="publication-source">Published on {{ .Params.publication }}{{ if eq .Params.media_type "podcast" }} • Podcast{{ end }}</p>
                {{ end }}
                
                {{ if .Params.custom_summary }}
                <div class="publication-description">
                    {{ .Summary }}
                </div>
                {{ else if .Summary }}
                <div class="publication-description">
                    {{ .Summary }}
                </div>
                {{ end }}
                
                <div class="publication-meta">
                    {{ if .Date }}
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
                    {{ end }}
                    {{ if $contentLink }}
                    <a href="{{ $contentLink }}" target="_blank" rel="noopener noreferrer" class="read-more">
                        Learn more on {{ $linkDomain | default (.Params.publication | default "external site") }} →
                    </a>
                    {{ end }}
                    {{ if .Params.spotify_url }}
                    <a href="{{ .Params.spotify_url }}" target="_blank" rel="noopener noreferrer" class="read-more">
                        Listen on Spotify →
                    </a>
                    {{ end }}
                </div>
            </div>
        </article>
        {{ end }}
    </div>
</div>
{{ end }}
